/*********************************************
XY-LC-301, BASIC
*********************************************/

//this program for hardware design version4,use new protocol(1st protocol)
//this program add some logic judgement for ALG detect,etc

//renewed:2003/8/21  control one_FEEdisplay green when handle up barrier
//renewed:2003/4/14  treat bug when received auto_up then handle_up , renewed flag control_mode2
//renewed:2002/8/16  add T2 timer to detect ALG and TTL working bit
//renewed:2002/8/14  change the protocol, add some system bit
//renewed:2002/7/3   add atuodetect system when power on (comm light on when system fail) 
//renewed:2002/4/23  add received message treat-send outside status to CPU,
//renewed:2002/4/11  add control speaker--------can speaker 'fee' and 'thanks' well
//renewed:2002/4/10  add control device program-can control
//renewed:2002/4/9   add detected program-------can detect outside and send to PC
//renewed:2002/4/9   add communication program--can communicate with PC

// 'A' type message
// STX  A  ADDR C_CHAR1  FEE1 FEE2 FEE3 FEE4  BAL1 BAL2 BAL3 BAL4  ENTR1 ENTR2 ENTR3 ENTR4 ENTR5 ENTR6 CX CN C_BAK  N  ETX  BCC
//  0   1   2    3        4     5   6    7     8    9    10   11     12   13    14     15   16    17   18 19  20   21  22   23
//
//'B' type message
// STX  'B'  ADDR(0x31)  D_CHAR1  D_BAK  ETX BCC
//  0   1   2      3       4      5   6

//***************************************************************************
Lane Controller Version 4.1
===========================


改进说明:
---------

    1.本代码在车道控制器第四版的基础上改进产生

    2.应用于电路版本Version 4.0



与上位机通讯协议说明:
====================

  A类信息(发送信息,未说明项均为1字节):
        起始码+通信类+设备地址+控制字节1+金额(4字节)+余额(4字节)+入口站(6字节)+车型+车种+控制字节2+通讯序号+结束码+校验码 (共24个 字节)

	控制字节: 
	0位: 起栏杆--1为抬杆，0为保持
	1位: 落栏杆--1为降杆，0为保持
	2位: 顶棚灯--1为绿灯，0为红灯
	3位: 声报警--1为声报警，0为声报警取消
	4位: 光报警--1为光报警，0为光报警取消
	5位: 通行灯--1为绿灯，0为红灯
	6位: 未定义--备用
	7位: 未定义--备用

	控制字节2：
	0位: 栏杆控制位  --1:车辆过后自动降杆模式，0:车辆过后手动降杆模式
	1位: 费额显示位  --1:费额显示，            0:费额不显示
	2位: 语音报价位  --1:报价，                0:不报价
	3位: 费额显示保持--1:保持，                0:刷新，当为1时，忽略bit1
        4位: 费显选择位  --1:广东版本，无保持功能，0:山西版本有保持功能，本控制需要费显支持
        5位: 车控器属性  --1:用于出口，            0:用于入口
    对于语音报价器，则播放相应语音控制如下:
          车种==0x37时，发'粤通卡写卡成功'
          车种==0x38时，发'欢迎光临'
          车种==0x31，并且金额==0x30,0x30,0x30,0x30时，发'通行卡写卡成功'	    
	
  B类信息(接收信息):
        起始码 + 通信类 + 设备地址 + 设备状态字节1 + 设备状态字节2 + 结束码 + 校验码 (共7个字节)
        其中设备状态字节的结构: 
	0位: 雨棚灯状态  --0为红灯，1为绿灯
	1位: 封道栏杆状态--0为打开，1为关闭
	2位: 脚踏报警状态--0为有报警，1为无报警
	3位: 自动栏杆状态--0为降杆，1为抬杆
	4位: 前线圈      --0为有车，1为无车
	5位: 后线圈      --0为有车，1为无车
	6位: 车道通行灯  --0为红灯，1为绿灯
	7位: 备用        --0为启动，1为无

	其中设备状态字节2的结构:
	0位: 备用
	1位: 备用
	2位: 栏杆   --('0'表示正常, '1'表示出错)
	3位: 备用
	4位: 备用
	5位: 备用
	6位: 顶棚灯 --('0'表示正常, '1'表示出错)
	7位: 备用

	 （相反？？？全为111？？？

  C类信息(调试命令)
        起始码  + 通信类 + 设备地址 + 调试命令 + 命令参数 + 结束码 + 校验码
	调试命令: 'R' - 复位
                  'V' - 取版本信息
		  'D' - 将车控器内存信息导出(.bin格式)
 		  ......
	命令参数: 整条C类信息的长度(包括起始、结束、校验码)固定为24字节，否则在命令参数项填充数据
                  到24字节。

	调试返回信息:
		1.所返回的信息格式: "XY" + 类别符 + 数据流 + 0x0D,0x0A
		2.类别符: '-'表示版本信息
                          '_'表示二进制数据流
                3.
注：0.操作栏杆机时，不论费额显示保持位如何，任何降/抬栏杆的操作，均会清除费显费额显示(但具有费额
      保持功能的费显在抬杆时不清除费额)
    1.复位时，车控器向上位机发版本信息，如：XY-LC-301-V4.1-40618
    2.当抬栏杆的时候，不需要主动控制语音，车控器会自动报‘谢谢，一路平安’之类语音。


与费显或语音报价器通讯协议说明:
==============================
数据信息：02 +CheXing +CheZhong +Fee +Balance +EntranceName +03 +BCC
          费显显示如上信息，对于语音报价器，则播放相应语音
          CheZhong==0x37时，发'粤通卡写卡成功'
          CheZhong==0x38时，发'欢迎光临'
          CheZhong==0x31，并且Fee==0x30,0x30,0x30,0x30时，发'通行卡写卡成功'

控制信息：02 +CtrlChar +03 +BCC
          CtrlChar: 'Y'-开费显绿灯,对于语音报价器，则报‘谢谢，请通行'语音
                    'Z'-开费显红灯


更新情况：
========
1.  V4.1(40405),增加老化模块，增加了TEST.C模块(加有标志0405S),上电时，在输入备用1(Bit6)接上5V即进考机
              状态.
              改善了因不断接收到命令时，每次都操作抬杆/降杆的同一动作.
              去掉了复位初始化外部设备的代码，以防止在收费的过程中偶然复位栏杆砸车.
              兼容8051/52，如果代码空间大于4K，必须采用8052.
              改进了自动检测外部设备工作情况的代码，只有在外部设备不正常的时候，才每隔3秒钟检测一次
              外设.

2.  V4.1(40618),修改了通讯协议(兼容通用、广佛--费额保持、太旧--防砸 版本)
              增加了每次开机或复位发送版本信息功能.

3.  V4.1(40720),增加了接收超时复位功能,恢复使用V4.1(40618)前协议.

4.  V4.1(40726),将对费显的操作从栏杆操作函数分离出来，改善了费额保持位的作用
              规范了对费显的操作.

5.  V4.1(40806),增加了栏杆状态和费显通行灯协同一致功能,防止可能出现抬杆红灯或降杆绿等的现象发生
              防止了重复控制费显通行灯.

6.  V4.1(40809),增加了'C'信息，用于维修诊断调试车控器.

7.  V4.1(40811),增加了栏杆操作的控制脉冲宽度，以确保栏杆的操作可靠性.
              改进了费显 显示/不显示 控制位因为2种费显版本中具有变绿灯保持功能的不清费显的异常

8.  V4.1(40812),修正了防砸功能启用栏杆不自动落杆的BUG.

9.  V4.1(40818),绑定费显通行灯与栏杆机一致性操作,增加了对开关控制栏杆机的控制(占用备用2输出端)
              将串口中断调整为高优先级别.
              为兼容开红灯/绿灯对费额的清除，去掉了防止重复发开红绿灯的代码,以便上位机器控制
              去掉了防止重复发抬栏杆的脉冲输出代码.
              增加了费显费额显示状态位，和对该位的判断.
10. V4.1(40819),要求每个函数增加了看门狗,以防止意外复位
11. V4.1(40820),稍微增加了栏杆控制脉冲时间
12. V4.1(40823),在通讯协议中增加了控制位，用于区分所使用的两种不同版本费显
13. V4.1(40901),解决了热复位第一次收到上位机器数据无反应的问题
14. V4.1(40906),增加防止栏杆操作与车道通行灯不一致的检测，当接收到PC的命令时，对车道通行灯的
                操作绑定于对栏杆操作
15. V4.1(40907),将状态检测再次确认时间间隔减少到10ms
16. V4.1(40909),调整了C类调试返回信息格式，并取消了冷启动发版本信息操作
17. V4.1(50222),应答信息,外设操作完成信息,费显出入口/山西广东版本设置指令,更正了contol_device
                和keep_device中的TTL_GREEN位
18. V4.1(08035),解决了栏杆操作时间过长而有可能导致失去车辆检测信号的问题;
                每次执行完有关栏杆操作的数据包后就清除有关栏杆自动降落的设置，解决了不能正常遥
		控栏杆的问题.
18. V4.1(08070),因08035在中断内移出了喂狗的代码,仍然保留主循环内的喂狗代码,却导致因看门狗经常复
                位导致的异常现象,本版本恢复中断内的喂狗代码,解决了异常复位引起的异常问题.
19. V4.1(08071),解决只有主循环内有喂狗代码的情况而不导致异常复位.
20. V4.1(08072),设法解决大卡机有时候台不起栏杆的情况.未测试解决.
V4.1（08073）   落杆时检测后线圈。
V4.1（160321）发抬杆时后线圈有车，需待后线圈无车后再通过一辆车才会自动落杆。
*************************************************************************************************/


